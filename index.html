<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω Kh√≥a H·ªçc ‚Ä¢ JSON driven</title>

  <!-- ‚ñ∏ Styles & fonts -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ‚ñ∏ Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    /* ====== Theme Variables ====== */
    :root {
      --primary-color: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      --secondary-color: #64748b;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #6b7280;
      --border-light: #e5e7eb;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --transition: all 0.2s ease;
    }

    /* ====== Global Styles ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      padding: 1.5rem;
      min-height: 100vh;
    }

    /* ====== Layout Containers ====== */
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    .app-header {
      background: var(--primary-gradient);
      color: #fff;
      padding: 2rem;
      text-align: center;
    }
    .app-header h1 { font-size: 2rem; font-weight: 700; margin-bottom: .5rem; }
    .app-header .subtitle { opacity: .9; }

    .content-area { padding: 2rem; }

    /* ====== Search ====== */
    .search-section { margin-bottom: 2rem; }
    .search-container { position: relative; max-width: 523333330px; }
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-size: .95rem;
      transition: var(--transition);
    }
    .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79,70,229,.1); }
    .search-icon { position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* ====== Table ====== */
    .table-container { overflow: hidden; border-radius: var(--radius-sm); box-shadow: var(--shadow-sm); }
    #courses { width: 100%; }
    #courses thead th {
      background: var(--primary-color);
      color: #fff;
      padding: 1rem;
      font-weight: 600;
      text-align: left;
    }
    #courses tbody td { padding: 1rem; border-bottom: 1px solid var(--border-light); }
    #courses tbody tr:hover { background: #f1f5f9; cursor: pointer; }

    .tuition { font-weight: 600; color: #177991; }

    /* ====== Mode Badges ====== */
    .mode-badge { padding: .4rem .8rem; border-radius: var(--radius-sm); font-size: .85rem; font-weight: 500; }
    .mode-badge.online  { background: rgba(16,185,129,.1); color: #10b981; }
    .mode-badge.hybrid  { background: rgba(245,158,11,.1); color: #f59e0b; }
    .mode-badge.offline { background: rgba(79,70,229,.1);  color: var(--primary-color); }

    /* ====== Mobile Cards ====== */
    .mobile-card-container { display: none; flex-direction: column; gap: 1.5rem; }
    .course-card { border: 1px solid var(--border-light); border-radius: var(--radius-sm); box-shadow: var(--shadow-sm); overflow: hidden; }
    .card-header { background: var(--primary-gradient); color: #fff; padding: 1rem; font-weight: 600; }
    .card-body  { padding: 1.5rem; }
    .card-row   { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid var(--border-light); }
    .card-row:last-child { border-bottom: none; }
    .card-row strong { min-width: 100px; }
    .card-footer { padding: 1rem; text-align: right; }
    .card-details-link { background: var(--primary-color); color: #fff; padding: .5rem 1rem; border-radius: var(--radius-sm); text-decoration: none; font-weight: 500; transition: var(--transition); }
    .card-details-link:hover { background: #4338ca; }

    /* ====== Phone link ====== */
    .phone-link { color: var(--primary-color); margin-left: .5rem; text-decoration: none; }

    /* ====== DataTables elements ====== */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: var(--text-secondary);
      font-size: .85rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button { border: 1px solid var(--border-light); border-radius: var(--radius-sm); margin: 0 .25rem; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--primary-color); color: #fff !important; }

    /* ====== Responsive tweaks ====== */
    @media (max-width: 1200px) { .desktop-table { display: none; } .mobile-card-container { display: flex; } }
    @media (max-width: 768px)  { body { padding: 1rem; } .content-area { padding: 1rem; } .app-header { padding: 1.5rem; } }
    @media (max-width: 480px)  { .app-header h1 { font-size: 1.5rem; } .app-header .subtitle { font-size: .9rem; } }
  </style>
</head>
<body>
  <div class="app-container">

    <main class="content-area">
      <!-- ‚ñ∏ Search -->
      <section class="search-section">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input id="globalSearch" class="search-input"
                 placeholder="T√¨m ki·∫øm th√¥ng tin kh√≥a h·ªçc, di·ªÖn gi·∫£, ƒë·ªãa ƒëi·ªÉm..."
                 autocomplete="off">
        </div>
      </section>

      <!-- ‚ñ∏ Desktop table -->
      <div class="desktop-table">
        <div class="table-container">
          <table id="courses" class="display nowrap">
            <thead>
              <tr>
                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th>Ng√†y k·∫øt th√∫c</th>
                <th>Gi·∫£ng vi√™n</th>
                <th>Kh√≥a h·ªçc</th>
                <th>ƒê·ªãa ƒëi·ªÉm</th>
                <th>H√¨nh th·ª©c</th>
                <th>H·ªçc ph√≠</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ‚ñ∏ Mobile cards -->
      <div id="mobileCardContainer" class="mobile-card-container"></div>
    </main>
  </div>

<script>
  /* ========================================================================
   *  Helper: b·ªè d·∫•u ti·∫øng Vi·ªát & lo·∫°i k√Ω t·ª± ƒë·∫∑c bi·ªát
   * ======================================================================*/
  const stripVN = str =>
    (str || '')
      .toString()
      .normalize('NFD')                // t√°ch d·∫•u
      .replace(/[\u0300-\u036f]/g, '') // b·ªè d·∫•u
      .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
      .replace(/[^\w\s]/g, '')         // b·ªè k√Ω t·ª± l·∫° (‚Ç´, ., , ...)
      .toLowerCase();

  const VND = n => (n || 0).toLocaleString('vi-VN') + ' ‚Ç´';
  const parseNum = t => parseInt(String(t).replace(/[^\d]/g, '')) || 0;

  const createModeBadge = mode => {
    const online = /online|zoom|tr·ª±c tuy·∫øn/i.test(mode);
    const hybrid = /hybrid|k·∫øt h·ª£p/i.test(mode);
    let cls, icon;
    if (online)      [cls, icon] = ['online',  'fa-video'];
    else if (hybrid) [cls, icon] = ['hybrid',  'fa-people-arrows'];
    else             [cls, icon] = ['offline', 'fa-chalkboard-teacher'];
    return `<span class="mode-badge ${cls}"><i class="fas ${icon}"></i> ${mode || '?'}</span>`;
  };

  /* ====== Custom sort for DD/MM/YYYY & VND ====== */
  $.fn.dataTable.ext.type.order['ddmmyyyy-pre'] = d => {
    if (!d || d.includes('--')) return 0;
    const [dd, mm, yyyy] = d.split('/') || [];
    return new Date(yyyy, mm - 1, dd).getTime() || 0;
  };
  $.fn.dataTable.ext.type.order['vnd-pre'] = t => parseNum(t);

  /* ----------------------------------------------------------------------
   *  üîç  Accent-insensitive, number-friendly SEARCH plug-in
   * -------------------------------------------------------------------- */
  $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
    const query = stripVN($('#globalSearch').val().trim().toLowerCase());
    if (!query) return true;

    // Ki·ªÉm tra t·ª´ng c·ªôt c·ªßa d·ªØ li·ªáu g·ªëc
    return Object.values(rowData).some(val => {
      if (typeof val === 'number') {
        // X·ª≠ l√Ω s·ªë ti·ªÅn (tuition) ho·∫∑c c√°c gi√° tr·ªã s·ªë
        return stripVN(VND(val)).includes(query) || String(val).includes(query);
      }
      // X·ª≠ l√Ω chu·ªói (bao g·ªìm HTML)
      const text = typeof val === 'string' ? val : String(val);
      return stripVN($('<div>').html(text).text()).includes(query);
    });
  });

  /* ========================================================================
   *  Data fetching
   * ======================================================================*/
  async function getData() {
    try {
      const res = await fetch('https://webhook.gnh.vn/webhook/event_info', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status);
      const raw = await res.json();
      return raw
        .filter(x => x.course && x.speaker)
        .map(x => ({
          start: x.start_date || '--/--/----',
          end: x.end_date || '--/--/----',
          speaker: x.speaker,
          course: x.course,
          loc: x.location || 'N/A',
          mode: x.learning_mode || 'N/A',
          fee: parseNum(x.tuition),
          href: x.href || '#'
        }));
    } catch (err) {
      console.warn('API l·ªói, d√πng d·ªØ li·ªáu demo:', err);
      return [
        { start: '10/06/2025', end: '15/06/2025', speaker: 'Nguy·ªÖn VƒÉn A', course: 'Python c∆° b·∫£n', loc: 'H√† N·ªôi', mode: 'Tr·ª±c tuy·∫øn', fee: 2000000, href: '#' },
        { start: '20/06/2025', end: '25/06/2025', speaker: 'Tr·∫ßn Th·ªã B', course: 'Qu·∫£n tr·ªã d·ª± √°n', loc: 'TP.HCM', mode: 'T·∫°i ch·ªó', fee: 3500000, href: '#' }
      ];
    }
  }

  /* ========================================================================
   *  Mobile card renderer
   * ======================================================================*/
  function fillCards(data) {
    const container = $('#mobileCardContainer').empty();
    if (!data || !data.length) {
      container.html('<p style="text-align:center;padding:1.5rem;color:var(--text-muted)">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc ph√π h·ª£p.</p>');
      return;
    }
    container.html(data.map(c => `
      <article class="course-card">
        <header class="card-header">${c.course}</header>
        <div class="card-body">
          <div class="card-row"><strong>Gi·∫£ng vi√™n:</strong> <span>${c.speaker}</span></div>
          <div class="card-row"><strong>Th·ªùi gian:</strong> <span>${c.start} - ${c.end}</span></div>
          <div class="card-row"><strong>ƒê·ªãa ƒëi·ªÉm:</strong> <span>${c.loc}</span></div>
          <div class="card-row"><strong>H√¨nh th·ª©c:</strong> <span>${createModeBadge(c.mode)}</span></div>
          <div class="card-row"><strong>H·ªçc ph√≠:</strong> <span class="tuition">${VND(c.fee)}</span></div>
        </div>
        <footer class="card-footer"><a href="${c.href}" target="_blank" class="card-details-link">Xem chi ti·∫øt</a></footer>
      </article>`).join(''));
  }

  /* ====== Debounce helper ====== */
  const debounce = (fn, ms = 250) => {
    let id;
    return (...args) => {
      clearTimeout(id);
      id = setTimeout(() => fn.apply(this, args), ms);
    };
  };

  /* ========================================================================
   *  Init
   * ======================================================================*/
  $(async () => {
    const courseData = await getData();
    fillCards(courseData);

    const dt = $('#courses').DataTable({
      data: courseData,
      columns: [
        { data: 'start' },
        { data: 'end' },
        { data: 'speaker' },
        { data: 'course' },
        { data: 'loc' },
        { data: 'mode' },
        { data: 'fee' }
      ],
      columnDefs: [
        { type: 'ddmmyyyy', targets: [0, 1] },
        { type: 'vnd', targets: 6 },
        {
          targets: 4, /* ƒê·ªãa ƒëi·ªÉm: n·∫øu c√≥ s·ªë ƒêT th√¨ th√™m link tel */
          render: (data) => `${data} ${/^\+?\d/.test(data.trim()) ? `<a href="tel:${data.trim()}" class="phone-link" title="G·ªçi ƒëi·ªán"><i class="fas fa-phone"></i></a>` : ''}`
        },
        { targets: 5, render: (d) => createModeBadge(d) },
        { targets: 6, render: (d) => `<span class="tuition">${VND(d)}</span>` }
      ],
      createdRow: (row, data) => $(row).attr('data-href', data.href),
      scrollX: true,
      order: [[0, 'asc']],
      pageLength: 25,
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'T·∫•t c·∫£']],
      dom: '<"top"l>rt<"bottom"ip>',
      autoWidth: false
    });

    /* ‚ñ∏ Global search: b·ªè d·∫•u + ƒë·ªìng b·ªô hai view */
    $('#globalSearch').on('input', debounce(function () {
      dt.search('').draw(); // X√≥a t√¨m ki·∫øm m·∫∑c ƒë·ªãnh ƒë·ªÉ s·ª≠ d·ª•ng plugin t√πy ch·ªânh
    }));

    dt.on('draw.dt', () => {
      fillCards(dt.rows({ search: 'applied' }).data().toArray());
    });

    /* ‚ñ∏ row click to open */
    $('#courses tbody').on('click', 'tr', function (e) {
      if ($(e.target).closest('a').length) return; /* avoid when clicking phone icon */
      const href = $(this).data('href');
      if (href && href !== '#') window.open(href, '_blank');
    });
  });
</script>
</body>
</html>
