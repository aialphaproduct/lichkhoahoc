<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω Kh√≥a H·ªçc ‚Ä¢ JSON driven</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

  <style>
    /* ====== Theme Variables ====== */
    :root {
      --primary-color: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      --secondary-color: #64748b;
      --bg-primary: #f1f5f9; /* Thay ƒë·ªïi n·ªÅn body ƒë·ªÉ th·∫•y r√µ card */
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #6b7280;
      --border-light: #e2e8f0; /* S·ª≠ d·ª•ng m√†u vi·ªÅn r√µ h∆°n */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --transition: all 0.2s ease;
    }

    /* ====== Global Styles ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      padding: 1.5rem;
      min-height: 100vh;
    }

    /* ====== Layout Containers ====== */
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      /* B·ªè overflow: hidden ƒë·ªÉ position: sticky ho·∫°t ƒë·ªông */
    }

    .app-header {
      background: var(--primary-gradient);
      color: #fff;
      padding: 2rem;
      text-align: center;
    }
    .app-header h1 { font-size: 2rem; font-weight: 700; margin-bottom: .5rem; }
    .app-header .subtitle { opacity: .9; }

    .content-area { padding: 1.5rem 2rem 2rem; } /* ƒêi·ªÅu ch·ªânh padding top */

    /* ====== Search ====== */
    .search-section {
      position: -webkit-sticky; /* D√†nh cho Safari */
      position: sticky;
      top: 0;
      z-index: 100; /* ƒê·∫£m b·∫£o n·∫±m tr√™n c√πng */
      background: var(--bg-card);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-light);
      border-radius: var(--radius-md) var(--radius-md) 0 0; /* Bo g√≥c tr√™n */
      margin: 0; /* Reset margin */
    }
    .search-container { position: relative; max-width: 100%; }
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-size: .95rem;
      transition: var(--transition);
      background: #f8fafc;
    }
    .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79,70,229,.1); }
    .search-icon { position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* ====== Table ====== */
    .table-container { overflow: hidden; border-radius: var(--radius-sm); box-shadow: var(--shadow-sm); }
    #courses { width: 100%; }
    #courses thead th {
      background: var(--primary-color);
      color: #fff;
      padding: 1rem;
      font-weight: 600;
      text-align: left;
    }
    #courses tbody td { padding: 1rem; border-bottom: 1px solid var(--border-light); }
    #courses tbody tr:hover { background: #f1f5f9; cursor: pointer; }

    .tuition { font-weight: 600; color: #177991; }

    /* ====== Mode Badges ====== */
    .mode-badge { padding: .4rem .8rem; border-radius: var(--radius-sm); font-size: .85rem; font-weight: 500; }
    .mode-badge.online  { background: rgba(16,185,129,.1); color: #10b981; }
    .mode-badge.hybrid  { background: rgba(245,158,11,.1); color: #f59e0b; }
    .mode-badge.offline { background: rgba(79,70,229,.1);   color: var(--primary-color); }

    /* ====== Mobile Cards ====== */
    .mobile-card-container { display: none; flex-direction: column; gap: 1.5rem; }
    .course-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      background: #fff;
      transition: var(--transition);
    }
    .course-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .card-thumbnail-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.9%;
      overflow: hidden;
      background: var(--primary-gradient);
    }
    .card-thumbnail {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
    }
    .card-thumbnail-placeholder {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem; text-align: center; padding: 1rem;
    }
    
    .card-header { padding: 1.25rem 1.25rem 0; }
    .card-title {
      color: var(--text-primary); font-size: 1.1rem; font-weight: 600; margin: 0 0 1rem 0; line-height: 1.4;
    }
    
    .card-body { padding: 0 1.25rem 1.25rem; }
    .card-meta {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;
    }
    .card-mode-badge {
      display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;
    }
    .card-mode-badge.online { background: #dcfdf7; color: #065f46; }
    .card-mode-badge.offline { background: #dbeafe; color: #1e40af; }
    .card-mode-badge.hybrid { background: #fef3c7; color: #92400e; }
    
    .card-info-grid { display: grid; gap: 0.75rem; margin-bottom: 1.25rem; }
    .card-info-item {
      display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;
    }
    .card-info-item .info-icon {
      color: var(--primary-color); width: 16px; text-align: center;
    }
    .card-info-item .info-value {
      color: var(--text-primary); font-weight: 500;
    }
    
    .card-price {
      font-size: 1.25rem; font-weight: 700; color: #dc2626; margin-bottom: 1rem;
    }
    
    .card-description {
      color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1.25rem; word-wrap: break-word; hyphens: auto;
    }
    
    .card-footer { padding: 0 1.25rem 1.25rem; display: flex; gap: 0.75rem; }
    .card-register-btn {
      flex: 1; background: #16a34a; color: #fff; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; font-weight: 600; transition: var(--transition); text-align: center; font-size: 0.9rem;
    }
    .card-register-btn:hover { background: #15803d; transform: translateY(-1px); }
    .card-details-btn {
      background: transparent; color: var(--primary-color); padding: 0.75rem 1rem; border: 1px solid var(--primary-color); border-radius: 8px; text-decoration: none; font-weight: 500; transition: var(--transition); font-size: 0.9rem;
    }
    .card-details-btn:hover { background: var(--primary-color); color: #fff; }

    /* ====== Phone link ====== */
    .phone-link { color: var(--primary-color); margin-left: .5rem; text-decoration: none; }

    /* ====== DataTables elements ====== */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: var(--text-secondary);
      font-size: .85rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button { border: 1px solid var(--border-light); border-radius: var(--radius-sm); margin: 0 .25rem; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--primary-color); color: #fff !important; }

    /* ====== Responsive tweaks ====== */
    @media (max-width: 1200px) { .desktop-table { display: none; } .mobile-card-container { display: flex; } }
    @media (max-width: 768px)  { body { padding: 1rem; } .content-area { padding: 1rem 1.5rem 1.5rem; } .search-section { padding: 1rem 1.5rem; border-radius: var(--radius-md) var(--radius-md) 0 0; } .app-header { padding: 1.5rem; } }
    @media (max-width: 480px)  {
      .app-header h1 { font-size: 1.5rem; }
      .app-header .subtitle { font-size: .9rem; }
      .card-footer { flex-direction: column; }
      .card-register-btn, .card-details-btn { text-align: center; }
    }
  </style>
</head>
<body>
  <div class="app-container">

    <section class="search-section">
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input id="globalSearch" class="search-input"
               placeholder="T√¨m ki·∫øm th√¥ng tin kh√≥a h·ªçc, di·ªÖn gi·∫£, ƒë·ªãa ƒëi·ªÉm..."
               autocomplete="off">
      </div>
    </section>

    <main class="content-area">
      <div class="desktop-table">
        <div class="table-container">
          <table id="courses" class="display nowrap">
            <thead>
              <tr>
                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th>Ng√†y k·∫øt th√∫c</th>
                <th>Gi·∫£ng vi√™n</th>
                <th>Kh√≥a h·ªçc</th>
                <th>ƒê·ªãa ƒëi·ªÉm</th>
                <th>H√¨nh th·ª©c</th>
                <th>H·ªçc ph√≠</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="mobileCardContainer" class="mobile-card-container"></div>
    </main>
  </div>

<script>
  /* ========================================================================
   * Helper: b·ªè d·∫•u ti·∫øng Vi·ªát & lo·∫°i k√Ω t·ª± ƒë·∫∑c bi·ªát
   * ======================================================================*/
  const stripVN = str =>
    (str || '')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
      .replace(/[^\w\s]/g, '')
      .toLowerCase();

  const parseNum = t => parseInt(String(t).replace(/[^\d]/g, '')) || 0;

  /*
   * [S·ª¨A ƒê·ªîI] H√†m VND ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ x·ª≠ l√Ω c·∫£ s·ªë v√† ch·ªØ
   */
  const VND = value => {
    const originalString = String(value || '').trim();
    if (originalString === '') return 'C·∫≠p nh·∫≠t';

    // Regex ƒë·ªÉ ki·ªÉm tra xem chu·ªói c√≥ ch·ª©a ch·ªØ c√°i hay kh√¥ng.
    // N·∫øu c√≥ ch·ªØ, n√≥ s·∫Ω ƒë∆∞·ª£c coi l√† vƒÉn b·∫£n (vd: "Th·ªèa thu·∫≠n").
    if (/[a-zA-Z]/.test(originalString)) {
      return originalString;
    }
    
    // N·∫øu kh√¥ng c√≥ ch·ªØ, n√≥ ƒë∆∞·ª£c coi l√† s·ªë v√† s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng.
    const num = parseNum(originalString);
    return num.toLocaleString('vi-VN') + ' ‚Ç´';
  };

  const createModeBadge = mode => {
    const online = /online|zoom|tr·ª±c tuy·∫øn/i.test(mode);
    const hybrid = /hybrid|k·∫øt h·ª£p/i.test(mode);
    let cls, icon;
    if (online)      [cls, icon] = ['online',  'fa-video'];
    else if (hybrid) [cls, icon] = ['hybrid',  'fa-people-arrows'];
    else             [cls, icon] = ['offline', 'fa-chalkboard-teacher'];
    return `<span class="mode-badge ${cls}"><i class="fas ${icon}"></i> ${mode || '?'}</span>`;
  };

  /* ====== Custom sort for DD/MM/YYYY & VND ====== */
  $.fn.dataTable.ext.type.order['ddmmyyyy-pre'] = d => {
    if (!d || d.includes('--')) return 0;
    const [dd, mm, yyyy] = d.split('/') || [];
    return new Date(yyyy, mm - 1, dd).getTime() || 0;
  };
  $.fn.dataTable.ext.type.order['vnd-pre'] = t => parseNum(t);

  /* ----------------------------------------------------------------------
   * üîç  Accent-insensitive, number-friendly SEARCH plug-in
   * -------------------------------------------------------------------- */
  $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
    const query = stripVN($('#globalSearch').val().trim().toLowerCase());
    if (!query) return true;

    return Object.values(rowData).some(val => {
      if (typeof val === 'number') {
        return stripVN(VND(val)).includes(query) || String(val).includes(query);
      }
      const text = typeof val === 'string' ? val : String(val);
      return stripVN($('<div>').html(text).text()).includes(query);
    });
  });

  /* ========================================================================
   * Data fetching
   * ======================================================================*/
  async function getData() {
    try {
      const res = await fetch('https://webhook.gnh.vn/webhook/event_info', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status);
      const raw = await res.json();
      return raw
        .filter(x => x.course && x.speaker)
        .map(x => ({
          start: x.start_date || '--/--/----',
          end: x.end_date || '--/--/----',
          speaker: x.speaker,
          course: x.course,
          loc: x.location || 'N/A',
          mode: x.learning_mode || 'N/A',
          // [S·ª¨A ƒê·ªîI] Gi·ªØ l·∫°i gi√° tr·ªã g·ªëc c·ªßa h·ªçc ph√≠ t·ª´ API
          fee: x.tuition,
          href: x.href || '#',
          thumbnail: x.thumbnail || '',
          description: x.description || '',
          categories: x.categories || ''
        }));
    } catch (err) {
      console.warn('API l·ªói, d√πng d·ªØ li·ªáu demo:', err);
      return [
        { start: '10/06/2025', end: '15/06/2025', speaker: 'Nguy·ªÖn VƒÉn A', course: 'Python c∆° b·∫£n', loc: 'H√† N·ªôi', mode: 'Tr·ª±c tuy·∫øn', fee: 2000000, href: '#', thumbnail: 'https://via.placeholder.com/289x165/4f46e5/ffffff?text=Python', description: 'Kh√≥a h·ªçc Python cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu', categories: 'L·∫≠p tr√¨nh' },
        { start: '20/06/2025', end: '25/06/2025', speaker: 'Tr·∫ßn Th·ªã B', course: 'Qu·∫£n tr·ªã d·ª± √°n', loc: 'TP.HCM', mode: 'T·∫°i ch·ªó', fee: 'Th·ªèa thu·∫≠n', href: '#', thumbnail: 'https://via.placeholder.com/289x165/7c3aed/ffffff?text=PM', description: 'Kh√≥a h·ªçc qu·∫£n tr·ªã d·ª± √°n chuy√™n nghi·ªáp', categories: 'Qu·∫£n l√Ω' }
      ];
    }
  }

  /* ========================================================================
   * Mobile card renderer
   * ======================================================================*/
  function fillCards(data) {
    const container = $('#mobileCardContainer').empty();
    if (!data || !data.length) {
      container.html('<p style="text-align:center;padding:1.5rem;color:var(--text-muted)">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc ph√π h·ª£p.</p>');
      return;
    }
    
    const getModeBadgeClass = mode => {
      const online = /online|zoom|tr·ª±c tuy·∫øn/i.test(mode);
      const hybrid = /hybrid|k·∫øt h·ª£p/i.test(mode);
      return online ? 'online' : hybrid ? 'hybrid' : 'offline';
    };
    
    const getModeIcon = mode => {
      const online = /online|zoom|tr·ª±c tuy·∫øn/i.test(mode);
      const hybrid = /hybrid|k·∫øt h·ª£p/i.test(mode);
      return online ? 'fa-video' : hybrid ? 'fa-people-arrows' : 'fa-chalkboard-teacher';
    };
    
    container.html(data.map(c => `
      <article class="course-card">
        <div class="card-thumbnail-container">
          ${c.thumbnail ? 
            `<img src="${c.thumbnail}" alt="${c.course}" class="card-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
             <div class="card-thumbnail-placeholder" style="display:none;">${c.course}</div>` : 
            `<div class="card-thumbnail-placeholder">${c.course}</div>`
          }
        </div>
        
        <div class="card-header">
          <h3 class="card-title">${c.course}</h3>
        </div>
        
        <div class="card-body">
          <div class="card-meta">
            <span class="card-mode-badge ${getModeBadgeClass(c.mode)}">
              <i class="fas ${getModeIcon(c.mode)}"></i>
              ${c.mode}
            </span>
          </div>
          
          <div class="card-info-grid">
            <div class="card-info-item">
              <i class="fas fa-user info-icon"></i>
              <span class="info-value">${c.speaker}</span>
            </div>
            <div class="card-info-item">
              <i class="fas fa-calendar info-icon"></i>
              <span class="info-value">${c.start} - ${c.end}</span>
            </div>
            <div class="card-info-item">
              <i class="fas fa-map-marker-alt info-icon"></i>
              <span class="info-value">${c.loc}</span>
            </div>
            ${c.categories ? `
            <div class="card-info-item">
              <i class="fas fa-tag info-icon"></i>
              <span class="info-value">${c.categories}</span>
            </div>` : ''}
          </div>
          
          <div class="card-price">${VND(c.fee)}</div>
          
          ${c.description ? `<div class="card-description">${c.description}</div>` : ''}
        </div>
        
        <div class="card-footer">
          <a href="${c.href}" target="_blank" class="card-register-btn">ƒêƒÉng k√Ω ngay</a>
          <a href="${c.href}" target="_blank" class="card-details-btn">Chi ti·∫øt</a>
        </div>
      </article>`).join(''));
  }

  /* ====== Debounce helper ====== */
  const debounce = (fn, ms = 250) => {
    let id;
    return (...args) => {
      clearTimeout(id);
      id = setTimeout(() => fn.apply(this, args), ms);
    };
  };

  /* ========================================================================
   * Init
   * ======================================================================*/
  $(async () => {
    const courseData = await getData();
    fillCards(courseData);

    const dt = $('#courses').DataTable({
      data: courseData,
      columns: [
        { data: 'start' },
        { data: 'end' },
        { data: 'speaker' },
        { data: 'course' },
        { data: 'loc' },
        { data: 'mode' },
        { data: 'fee' }
      ],
      columnDefs: [
        { type: 'ddmmyyyy', targets: [0, 1] },
        { type: 'vnd', targets: 6 },
        {
          targets: 4,
          render: (data) => `${data} ${/^\+?\d/.test(String(data).trim()) ? `<a href="tel:${String(data).trim()}" class="phone-link" title="G·ªçi ƒëi·ªán"><i class="fas fa-phone"></i></a>` : ''}`
        },
        { targets: 5, render: (d) => createModeBadge(d) },
        { targets: 6, render: (d) => `<span class="tuition">${VND(d)}</span>` }
      ],
      createdRow: (row, data) => $(row).attr('data-href', data.href),
      scrollX: true,
      order: [[0, 'asc']],
      pageLength: 25,
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'T·∫•t c·∫£']],
      dom: '<"top"l>rt<"bottom"ip>',
      autoWidth: false,

      fixedColumns: {
          left: 3
      }
    });

    $('#globalSearch').on('input', debounce(function () {
      dt.search(this.value).draw();
    }));

    dt.on('draw.dt', () => {
      fillCards(dt.rows({ search: 'applied' }).data().toArray());
    });

    $('#courses tbody').on('click', 'tr', function (e) {
      if ($(e.target).closest('a').length) return;
      const href = $(this).data('href');
      if (href && href !== '#') window.open(href, '_blank');
    });
  });
</script>
</body>
</html>